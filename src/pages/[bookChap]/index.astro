---
import Layout from "@layouts/Layout.astro";
import {AppWrapper} from "@components/AppWrapper";
import { actions } from 'astro:actions';

// Get all shared page data
const { data: pageData, error } = await Astro.callAction(actions.getPageData, {});
if (error || !pageData) return Astro.redirect("/404");

const {
  playlist,
  playlistDisplayName,
  preferredLocale,
  initialDict,
  videojsInitalDict,
  userPreferences,
  bucketized,
  cfEnv
} = pageData;

// BOOK/CHAPTER ROUTING SPECIFIC LOGIC
const {bookChap} = Astro.params;

//Regex = Start with any word or digit, then optional . separator, any number of optional digits (bc we want to match just a book e.g mat if given), and then another set of option digits.  Will match
// Luk, Luk.2, LUK.2.7, 2jn.1, luk27.  Even the last is fine without the period since we'll just treat the two matches as book/chap
const bookChapRegex = /^([\d\w]+)(?:\.)?(\d+)?(?:\.)?(\d+)?/i;
const routingParts = bookChap && bookChap.match(bookChapRegex);
const bookRouting = routingParts && routingParts?.[1]?.toUpperCase();
const chapRouting = routingParts && Number(routingParts?.[2]);
const verseRouting = (routingParts && routingParts?.[3]) || undefined;
const defaultBook =
  bookRouting && bucketized[bookRouting]
    ? bucketized[bookRouting]
    : bucketized[Object.keys(bucketized)[0]];

const defChapIdx = defaultBook.findIndex(
  (chap) => Number(chap.chapter) == Number(chapRouting)
);
const defaultChap = defChapIdx > -1 ? defaultBook[defChapIdx] : defaultBook[0];
const initialData = {vids: defaultBook, chap: defaultChap, verseRouting};

// Cache control headers for book/chapter pages
Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=3600, s-maxage=86400, must-revalidate"
);
---

<Layout
  title={playlist}
  initialDict={initialDict}
  preferredLocale={preferredLocale}
>
  <div class="grid grid-rows-[auto_auto_1fr] overflow-y-auto">
    <AppWrapper
      client:load
      userPreferences={userPreferences}
      initialData={initialData}
      playlist={playlist}
      playlistDisplayName={playlistDisplayName}
      vids={bucketized}
      locale={preferredLocale}
      initialDict={initialDict}
      videojsInitalDict={videojsInitalDict}
      playerEnv={cfEnv}
    />
  </div>
</Layout>
