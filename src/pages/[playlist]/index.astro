---
import Layout from "@layouts/Layout.astro";
import type { IVidWithCustom } from "@customTypes/types";

import {
  groupObjectsByKey,
  getUserPreferences,
getPreferredLangFromHeader,
mutateSortVidsArray,
// getPreferredLangFromHeader
} from "@utils";
import { Header } from "@components/Header";
import { AppWrapper } from "@components/AppWrapper";
import { getPlaylistData } from "@lib/routes";
const {playlist} = Astro.params;
if (!playlist) return Astro.redirect('404')

const preferredLocale = getPreferredLangFromHeader(Astro.request)
const initialDictModule = await import(`../../i18n/${preferredLocale}.ts`)
const initialDict = {
  [preferredLocale]: initialDictModule.default
}



let userPreferences = getUserPreferences(Astro)
// console.log({userPreferences})
// console.log(Astro.url.origin, playlist)
let data = await getPlaylistData(Astro.url.origin, playlist)
if (!data) return Astro.redirect('404')
// type coercion here to add a few extra types below on this vids array. 
const vids = data.videos as IVidWithCustom[]
if (!vids || !vids.length) {
  return new Response(null, {
    status: 404
  })
}
const {sortedVids, filteredByMatchingReferenceId} = mutateSortVidsArray(vids)
const bucketized = groupObjectsByKey<IVidWithCustom, "book">(sortedVids, "book");
bucketized.other = filteredByMatchingReferenceId.notMatching
// const chapRouting = routingParts && routingParts?.[2]
// const verseRouting = routingParts && routingParts?.[3]
const defaultBook =  bucketized[Object.keys(bucketized)[0]];
const defaultChap =  defaultBook[0]

const initialData = {vids: defaultBook, chap: defaultChap, verseRouting:undefined}
---

<Layout title="Experiments">
	<div class="">
		<Header client:idle prefersDark={userPreferences?.prefersDark}/>
  <div
    class="grid grid-rows-[auto_auto_1fr] overflow-y-auto"
  
  >
      <AppWrapper client:load userPreferences={userPreferences} initialData={initialData} playlist={playlist} vids={bucketized} locale={preferredLocale} initialDict={initialDict}/>
 </div> 
</div> 
</Layout>


<!-- <script define:vars={{ myPlayerUrl }} is:inline src={myPlayerUrl}></script> -->
